<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Sign up</title>
</head>
<body>
    <h1>Create account</h1>

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    <form method="post">
        <label>Email</label>
        <input type="email" name="email" required />

        <label>Password</label>
        <input type="password" name="password" required />

        <button type="submit">Sign up</button>
    </form>

    <hr />

    <button id="google-btn">Continue with Google</button>

    <p>
        Already have an account?
        <a href="{{ url_for('login') }}">Login</a>
    </p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

        const firebaseConfig = {{ firebase_config | tojson }};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const btn = document.getElementById("google-btn");
        btn.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const idToken = await user.getIdToken();

                await fetch("/google-session", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: user.email, idToken })
                });

                window.location.href = "/dashboard";
            } catch (err) {
                alert("Google sign-in failed");
            }
        });
    </script>
</body>
</html>